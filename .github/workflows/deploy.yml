name: Build and Deploy Update Site

on:
  push:
    branches:
      - main
      - develop
    paths-ignore:
      - '**/*.md'
      - '.gitignore'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build with Maven
        run: xvfb-run mvn clean verify
        env:
          # ãƒ­ãƒ¼ã‚«ãƒ«ã§çªç ´ã—ãŸXMLåˆ¶é™è§£é™¤ã®å‘ªæ–‡
          MAVEN_OPTS: >-
            -Djdk.xml.maxGeneralEntitySizeLimit=0
            -Djdk.xml.totalEntitySizeLimit=0
            -Djdk.xml.entityExpansionLimit=0
            
      - name: ğŸ“„ Create Info HTML for Browser Access
        run: |
          cat << 'EOF' > JHappy4AI-updatesite/target/repository/index.html
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Eclipse Update Site - JHappy4AI</title>
              <style>
                  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; color: #2c3e50; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
                  .card { background: white; padding: 2.5rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 600px; width: 100%; text-align: center; border-top: 5px solid #3498db; }
                  h1 { font-size: 1.5rem; margin-top: 0; color: #2c3e50; }
                  .lang-section { text-align: left; background: #f8f9fa; padding: 1.5rem; border-radius: 6px; margin-bottom: 1.5rem; border-left: 4px solid #bdc3c7; }
                  .lang-section p { margin: 0 0 0.8rem 0; font-size: 0.95rem; line-height: 1.5; }
                  .lang-section strong { color: #e74c3c; }
                  .home-btn { display: inline-block; background-color: #3498db; color: white; padding: 0.8rem 1.5rem; border-radius: 5px; text-decoration: none; font-weight: bold; margin-top: 1rem; transition: background-color 0.2s; }
                  .home-btn:hover { background-color: #2980b9; }
              </style>
          </head>
          <body>
              <div class="card">
                  <h1>ğŸ”Œ Eclipse Update Site</h1>
                  
                  <div class="lang-section">
                      <p><strong>ğŸ‡ºğŸ‡¸ English:</strong><br>This URL is an <strong>Eclipse Update Site</strong>. It is not meant to be viewed in a web browser.<br>Please copy this URL and paste it into Eclipse's <em>"Install New Software..."</em> dialog to install the plugin.</p>
                  </div>

                  <div class="lang-section">
                      <p><strong>ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª:</strong><br>ã“ã“ã¯ <strong>Eclipseã®æ›´æ–°ã‚µã‚¤ãƒˆï¼ˆUpdate Siteï¼‰</strong> ã§ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã§é–²è¦§ã™ã‚‹ãŸã‚ã®ãƒšãƒ¼ã‚¸ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>ã“ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€Eclipseã® <em>ã€Œæ–°è¦ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«...ã€</em> ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«è²¼ã‚Šä»˜ã‘ã¦ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚</p>
                  </div>

                  <div class="lang-section">
                      <p><strong>ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡:</strong><br>è¿™æ˜¯ä¸€ä¸ª <strong>Eclipse æ›´æ–°ç«™ç‚¹ (Update Site)</strong>ã€‚å®ƒä¸é€‚åˆåœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹ã€‚<br>è¯·å¤åˆ¶æ­¤ URL å¹¶å°†å…¶ç²˜è´´åˆ° Eclipse çš„ <em>â€œå®‰è£…æ–°è½¯ä»¶...â€</em> å¯¹è¯æ¡†ä¸­ä»¥å®‰è£…æ’ä»¶ã€‚</p>
                  </div>

                  <a href="https://tatoo2018.github.io/JHappy4AI/" class="home-btn">ğŸ  Go to JHappy4AI Homepage</a>
              </div>
          </body>
          </html>
          EOF

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          # å…¬é–‹ã™ã‚‹æˆæœç‰©ãŒã‚ã‚‹ãƒ•ã‚©ãƒ«ãƒ€
          folder: JHappy4AI-updatesite/target/repository
          # å…¬é–‹å°‚ç”¨ã®åˆ¥ãƒ–ãƒ©ãƒ³ãƒï¼ˆå‹æ‰‹ã«ä½œã‚‰ã‚Œã¾ã™ï¼‰
          branch: gh-pages
          # ãƒ–ãƒ©ãƒ³ãƒã«ã‚ˆã£ã¦ä¿å­˜å…ˆã‚’è‡ªå‹•å¤‰æ›´ã™ã‚‹_
          target-folder: updatesite/${{ github.ref_name }}
          # ä»–ã®ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆindex.htmlãªã©ï¼‰ã‚’æ¶ˆã•ãªã„ã‚ˆã†ã«è¨­å®š
          clean: true
          
          # 
          single-commit: true
